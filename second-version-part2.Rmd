---
title: "Data Preprocessing and Logistic Regression"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(caret)
library(MASS)
library(tidyr)
knitr::opts_chunk$set(echo = TRUE)
```

## **Load and Preprocess Data**

```{r load-data}
# Load dataset (Assume `hw` is preloaded)
str(hw)

# Ensure only "Zone-2" and "Zone-3" are included
hw <- hw %>% filter(y %in% c("Zone-2", "Zone-3"))
hw$y <- factor(hw$y)  # Convert to factor

# Standardize numerical features
hw_scaled <- hw %>% dplyr::select(-y) %>% scale() %>% as.data.frame()
hw_scaled$y <- hw$y

# Check class balance
table(hw_scaled$y)
```

## **Split Data into Train and Test Sets**

```{r split-data}
set.seed(123)  # Ensure reproducibility
trainIndex <- createDataPartition(hw_scaled$y, p = 0.8, list = FALSE)
trainData <- hw_scaled[trainIndex, ]
testData <- hw_scaled[-trainIndex, ]
```

## **Train Logistic Regression Model**

```{r train-model}
model <- glm(y ~ ., data = trainData, family = binomial, control = list(maxit = 1000))
summary(model)
```

## **Predictions and Performance Evaluation**

```{r predict-evaluate}
# Predict probabilities on the test dataset
scores <- predict(model, testData, type = "response")

# Extract prediction scores per HR zone
scores_zone2 <- scores[testData$y == "Zone-2"]
scores_zone3 <- scores[testData$y == "Zone-3"]

# Perform Mann-Whitney U Test
mw_test <- wilcox.test(scores_zone2, scores_zone3)
mw_test$p.value

# Perform Kolmogorov-Smirnov Test
ks_test <- ks.test(scores_zone2, scores_zone3)
ks_test$p.value
```

## **Permutation Test**

```{r permutation-test}
perm_test <- function(scores_0, scores_1, num_perm = 1000) {
  observed_stat <- abs(mean(scores_0) - mean(scores_1))
  perm_stats <- replicate(num_perm, {
    combined <- sample(c(scores_0, scores_1))
    perm_stat <- abs(mean(combined[1:length(scores_0)]) - mean(combined[(length(scores_0) + 1):length(combined)]))
    return(perm_stat)
  })
  p_value <- mean(perm_stats >= observed_stat)
  return(p_value)
}

# Run permutation test
perm_test(scores_zone2, scores_zone3)
```

## **Power Simulation Study**

```{r power-simulation}
simulate_power_optimized <- function(mu_shift, n0, n1, k, num_sim = 500) {
  power <- 0
  for (i in 1:num_sim) {
    X0 <- mvrnorm(n0, mu = rep(0, k), Sigma = diag(k))
    X1 <- mvrnorm(n1, mu = rep(mu_shift, k), Sigma = diag(k))
    data <- data.frame(rbind(X0, X1), class = as.factor(c(rep(0, n0), rep(1, n1))))
    model <- glm(class ~ ., data = data, family = binomial, control = list(maxit = 1000))
    scores <- predict(model, data, type = "response")
    p_value <- wilcox.test(scores[1:n0], scores[(n0 + 1):(n0 + n1)])$p.value
    power <- power + as.integer(p_value < 0.05)
  }
  return(power / num_sim)
}
```

## **Plot Power Curve**

```{r plot-power}
# Run power analysis for different mean shifts
power_values <- sapply(seq(0, 2, by = 0.2), function(d) simulate_power_optimized(d, 50, 50, 4, 100))

# Plot Power Curve
plot(seq(0, 2, by = 0.2), power_values, type = "b",
     main = "Power vs. Mean Shift", xlab = "Mean Shift (Î”)", ylab = "Power",
     col = "blue", pch = 19)
```

## **Conclusion**

This R Markdown file performs:
- Data preprocessing (filtering and standardization)
- Logistic regression training and evaluation
- Permutation and hypothesis testing
- Power simulation study

**End of Report**